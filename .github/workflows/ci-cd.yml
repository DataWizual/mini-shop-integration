name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # üîç –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Basic structure validation
        run: |
          echo "üîç Checking project structure..."
          
          # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ
          [ -f docker-compose.yml ] && echo "‚úÖ docker-compose.yml exists" || exit 1
          [ -f script_manager.py ] && echo "‚úÖ script_manager.py exists" || exit 1
          
          # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ diagnostics
          [ -f diagnostics/control_panel.sh ] && echo "‚úÖ control_panel.sh exists" || exit 1
          [ -f diagnostics/master_analyzer.py ] && echo "‚úÖ master_analyzer.py exists" || exit 1
          [ -f diagnostics/monitoring_bridge.py ] && echo "‚úÖ monitoring_bridge.py exists" || exit 1
          [ -f diagnostics/auto_detector.py ] && echo "‚úÖ auto_detector.py exists" || exit 1
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
          [ -d monitoring ] && echo "‚úÖ monitoring directory exists" || exit 1
          [ -d diagnostics ] && echo "‚úÖ diagnostics directory exists" || exit 1
          [ -d ai-analysis ] && echo "‚úÖ ai-analysis directory exists" || exit 1
          [ -d ai-reporter ] && echo "‚úÖ ai-reporter directory exists" || exit 1
          
          echo "üìÅ Project structure validation passed"

  # üê≥ –®–ê–ì 2: Docker —Å–±–æ—Ä–∫–∞
  docker-build:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker images
        run: |
          echo "üê≥ Testing Docker image builds..."
          docker compose build --no-cache app
          echo "‚úÖ App image builds successfully"

  # üß™ –®–ê–ì 3: –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  basic-tests:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python syntax check
        run: |
          echo "üêç Checking Python syntax..."
          
          # Core AI components –≤ diagnostics
          python -m py_compile diagnostics/master_analyzer.py
          python -m py_compile diagnostics/monitoring_bridge.py
          python -m py_compile diagnostics/network_analyzer.py
          python -m py_compile diagnostics/auto_detector.py
          
          # Diagnostic scripts
          python -m py_compile diagnostics/check_dashboards.py
          python -m py_compile diagnostics/check_grafana.py
          python -m py_compile diagnostics/check_panels.py
          python -m py_compile diagnostics/check_promtail_port.py
          python -m py_compile diagnostics/deep_promtail_debug.py
          python -m py_compile diagnostics/final_fixes.py
          python -m py_compile diagnostics/fix_dashboards.py
          python -m py_compile diagnostics/fix_grafana_datasource.py
          python -m py_compile diagnostics/fix_loki_logs.py
          python -m py_compile diagnostics/fix_promtail.py
          python -m py_compile diagnostics/universal_dashboard_fixer.py
          
          # AI modules
          python -m py_compile ai-analysis/smart_analyzer.py
          python -m py_compile ai-reporter/insight_generator.py
          
          # Management –≤ –∫–æ—Ä–Ω–µ
          python -m py_compile script_manager.py
          
          echo "‚úÖ All Python files compile successfully"
      
      - name: Shell script validation
        run: |
          echo "üìú Validating shell scripts..."
          
          # –°–∫—Ä–∏–ø—Ç—ã –≤ diagnostics
          shellcheck diagnostics/control_panel.sh || echo "‚ö†Ô∏è ShellCheck warnings in control_panel.sh"
          shellcheck diagnostics/quick_check.sh || echo "‚ö†Ô∏è ShellCheck warnings in quick_check.sh"
          shellcheck diagnostics/quick_ai_check.sh || echo "‚ö†Ô∏è ShellCheck warnings in quick_ai_check.sh"
          shellcheck diagnostics/deploy-local.sh || echo "‚ö†Ô∏è ShellCheck warnings in deploy-local.sh"
          
          # –°–∫—Ä–∏–ø—Ç—ã –≤ scripts
          shellcheck scripts/*.sh || echo "‚ö†Ô∏è ShellCheck warnings in scripts"
          
          echo "‚úÖ Shell scripts validated"

  # üìä –®–ê–ì 4: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
  code-analysis:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Code metrics
        run: |
          echo "üìä Code metrics:"
          echo "Total Python files: $(find . -name '*.py' | wc -l)"
          echo "Total Shell scripts: $(find . -name '*.sh' | wc -l)"
          echo "Diagnostics scripts: $(find diagnostics -name '*.py' | wc -l)"
          echo "AI components: $(find ai-* -name '*.py' | wc -l)"
          echo "Total lines: $(find . -name '*.py' -o -name '*.sh' | xargs wc -l | tail -1 | awk '{print $1}')"

  # üê≥ –®–ê–ì 2.5: Push to DockerHub
  docker-push:
    runs-on: ubuntu-latest
    needs: [health-check, docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to DockerHub
        run: |
          echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      
      - name: Build and push App image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-app:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-app:latest
          echo "‚úÖ App image pushed to DockerHub"

  # üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  report:
    runs-on: ubuntu-latest
    needs: [health-check, docker-build, basic-tests, code-analysis]
    steps:
      - name: Generate CI/CD report
        run: |
          echo "üéâ CI/CD Pipeline Execution Complete"
          echo "======================================"
          echo "‚úÖ Health checks passed"
          echo "‚úÖ Docker builds successful" 
          echo "‚úÖ Basic tests completed"
          echo "‚úÖ Code analysis finished"
          echo ""
          echo "üöÄ Universal AI Monitoring Platform Status:"
          echo "‚Ä¢ Core AI Components: ‚úÖ Compiled"
          echo "‚Ä¢ Diagnostic Scripts: ‚úÖ Validated" 
          echo "‚Ä¢ Shell Scripts: ‚úÖ Checked"
          echo "‚Ä¢ Project Structure: ‚úÖ Verified"
