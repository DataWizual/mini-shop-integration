name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ” Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Basic structure validation
        run: |
          echo "ğŸ” Checking project structure..."
          [ -f docker-compose.yml ] && echo "âœ… docker-compose.yml exists" || exit 1
          [ -f control_panel.sh ] && echo "âœ… control_panel.sh exists" || exit 1
          [ -f master_analyzer.py ] && echo "âœ… master_analyzer.py exists" || exit 1
          echo "ğŸ“ Project structure validation passed"

  # ğŸ³ Ğ¨ĞĞ“ 2: Docker ÑĞ±Ğ¾Ñ€ĞºĞ°
  docker-build:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker images
        run: |
          echo "ğŸ³ Testing Docker image builds..."
          docker compose build --no-cache app
          echo "âœ… App image builds successfully"

  # ğŸ§ª Ğ¨ĞĞ“ 3: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  basic-tests:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python syntax check
        run: |
          echo "ğŸ Checking Python syntax..."
          python -m py_compile master_analyzer.py
          python -m py_compile monitoring_bridge.py
          python -m py_compile ai-analysis/smart_analyzer.py
          python -m py_compile ai-reporter/insight_generator.py
          echo "âœ… All Python files compile successfully"
      
      - name: Shell script validation
        run: |
          echo "ğŸ“œ Validating shell scripts..."
          shellcheck control_panel.sh || echo "âš ï¸ ShellCheck warnings (non-critical)"
          shellcheck scripts/*.sh || echo "âš ï¸ ShellCheck warnings in scripts"
          echo "âœ… Shell scripts validated"

  # ğŸ“Š Ğ¨ĞĞ“ 4: ĞĞ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°
  code-analysis:
    runs-on: ubuntu-latest
    needs: health-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Code metrics
        run: |
          echo "ğŸ“Š Basic code metrics:"
          echo "Python files: $(find . -name '*.py' | wc -l)"
          echo "Shell scripts: $(find . -name '*.sh' | wc -l)"
          echo "Total lines of code: $(find . -name '*.py' -o -name '*.sh' | xargs wc -l | tail -1)"

  # ğŸ³ Ğ¨ĞĞ“ 2.5: Push to DockerHub
  docker-push:
    runs-on: ubuntu-latest
    needs: [health-check, docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to DockerHub
        run: |
          echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      
      - name: Build and push App image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-app:latest ./app
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-app:latest
          echo "âœ… App image pushed to DockerHub"

  # ğŸ¯ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
  report:
    runs-on: ubuntu-latest
    needs: [health-check, docker-build, basic-tests, code-analysis]
    steps:
      - name: Generate CI/CD report
        run: |
          echo "ğŸ‰ CI/CD Pipeline Execution Complete"
          echo "======================================"
          echo "âœ… Health checks passed"
          echo "âœ… Docker builds successful" 
          echo "âœ… Basic tests completed"
          echo "âœ… Code analysis finished"
          echo ""
          echo "ğŸ“ˆ Next steps to consider:"
          echo "â€¢ Add integration tests with test containers"
          echo "â€¢ Add security scanning"
          echo "â€¢ Add performance benchmarks"
          echo "â€¢ Add automated deployment"